# ИНСТРУКЦИЯ: Управление видимостью графиков

## РЕАЛИЗОВАНО

✅ Все графики/тренды скрыты при запуске проекта  
✅ Для каждого графика добавлена кнопка "Показать график" / "Скрыть график"  
✅ Кнопки расположены рядом с соответствующими графиками  
✅ Данные продолжают собираться в фоне даже когда графики скрыты  

---

## ЧТО ДОБАВЛЕНО

### 1. CSS Template
- **Узел**: "CSS для скрытия графиков" (ui_template)
- **Расположение**: После ui_base
- **Функция**: Определяет CSS класс `.chart-hidden` для скрытия графиков

### 2. Кнопки управления (11 штук)
Для каждого графика добавлена кнопка:
- **Тип**: ui_button
- **Название**: "Показать/Скрыть: [Название графика]"
- **Расположение**: Перед графиком в той же группе
- **Текст**: "Показать график" (при скрытом) / "Скрыть график" (при видимом)

### 3. Function узлы переключения (11 штук)
- **Название**: "Переключить: [Название графика]"
- **Функция**: 
  - Переключает состояние видимости графика
  - Сохраняет состояние в глобальной переменной `chart_visible_[id]`
  - Отправляет команду в ui_control для изменения className
  - Обновляет текст кнопки

### 4. UI Control узлы (11 штук)
- **Название**: "Контроль: [Название графика]"
- **Функция**: Применяет изменения className к графику для показа/скрытия

### 5. Инициализация при старте
- **Inject узел**: "При старте: скрыть графики"
- **Function узел**: "Инициализация: скрыть все графики"
- **UI Control узел**: "Контроль инициализации графиков"
- **Функция**: При запуске Node-RED автоматически скрывает все графики

---

## СПИСОК ГРАФИКОВ С УПРАВЛЕНИЕМ

1. **График итерации X** (Таб: Итерация)
2. **AI Каналы 6717** (Таб: Home) 
3. **График PH и Концентраций** (Таб: Переменные Расчета PH)
4. **График PH (0-10)** (Таб: Переменные Расчета PH)
5. **График Входов (ai2h1, ai2h2)** (Таб: Переменные Расчета PH)
6. **График Redox** (Таб: Redox Потенциал)
7. **График Redox2** (Таб: Redox Потенциал 2)
8. **График Токов АО LC** (Таб: Аналоговые Выходы LC)
9. **PV и Уставка (SP)** (Таб: Настройки ПИД)
10. **Выход ПИД (0-1)** (Таб: Настройки ПИД)
11. **Сигнал на клапан (4-20 мА)** (Таб: Настройки ПИД)

---

## КАК РАБОТАЕТ

1. **При запуске проекта:**
   - Inject узел "При старте: скрыть графики" срабатывает автоматически (once: true, delay: 0.1s)
   - Function узел устанавливает все глобальные переменные `chart_visible_*` в `false`
   - UI Control узел применяет класс `chart-hidden` ко всем графикам
   - Все графики скрыты через CSS: `display: none !important`

2. **При нажатии кнопки "Показать график":**
   - Кнопка отправляет ID графика в Function узел
   - Function узел переключает состояние видимости (false → true)
   - Сохраняет новое состояние в глобальной переменной
   - Отправляет команду в UI Control для удаления класса `chart-hidden`
   - Обновляет текст кнопки на "Скрыть график"
   - График становится видимым

3. **При нажатии кнопки "Скрыть график":**
   - Аналогично, но состояние меняется (true → false)
   - Класс `chart-hidden` добавляется обратно
   - Текст кнопки меняется на "Показать график"
   - График скрывается

4. **Сбор данных:**
   - Данные продолжают собираться и обрабатываться независимо от видимости графика
   - Когда график показывается, он отображает все данные, собранные за время скрытия

---

## ФАЙЛЫ

- **Оригинал**: `flows_AO6224_AI6717_ver_311020251659.json`
- **Резервная копия**: `flows_AO6224_AI6717_ver_311020251659_backup_original.json`
- **Финальная версия**: `flows_AO6224_AI6717_ver_311020251659_FINAL.json`

**Используйте финальную версию для загрузки в Node-RED!**

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ

### Используемые узлы (только стандартные)
- **ui_button** (node-red-dashboard) - кнопки управления
- **ui_control** (node-red-dashboard) - управление виджетами
- **ui_template** (node-red-dashboard) - CSS стили
- **function** (core) - логика переключения
- **change** (core) - обновление текста кнопок
- **inject** (core) - инициализация при старте

### Глобальные переменные
Для каждого графика создается переменная:
- `chart_visible_[первые 8 символов ID графика]`
- Значение: `true` (видим) или `false` (скрыт)

### CSS класс
- Класс: `chart-hidden`
- Стиль: `display: none !important`
- Определяется в `ui_template` узле
- Применяется через `ui_control` узел

### Формат сообщений для ui_control
```javascript
{
    id: "chart_id",
    ui_control: {
        className: "chart-hidden"  // или "" для показа
    }
}
```

### Структура потока для каждого графика
```
[ui_button] → [function] → [ui_control] → (график)
              ↓
         [change] → [ui_button] (обновление текста)
```

---

## ПРОВЕРКА РАБОТЫ

1. Загрузите файл `flows_AO6224_AI6717_ver_311020251659_FINAL.json` в Node-RED
2. Разверните поток (Deploy)
3. Откройте Dashboard
4. Убедитесь, что все графики скрыты
5. Нажмите кнопку "Показать график" рядом с любым графиком
6. График должен появиться, кнопка должна измениться на "Скрыть график"
7. Нажмите "Скрыть график" - график должен скрыться

---

## ВОЗМОЖНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### Графики не скрываются при старте
- Проверьте, что Inject узел "При старте: скрыть графики" имеет `once: true`
- Проверьте задержку `onceDelay: 0.1`

### Кнопка не работает
- Проверьте соединения: кнопка → function → ui_control
- Проверьте, что payload кнопки содержит правильный ID графика

### График не показывается/скрывается
- Проверьте, что CSS template загружен
- Проверьте в браузере (F12), что класс `chart-hidden` применяется/удаляется
- Убедитесь, что ui_control узел получает правильные сообщения

---

## ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ

Если нужно добавить общую кнопку "Показать все графики" / "Скрыть все графики":
1. Создайте отдельную кнопку
2. Подключите к Function узлу, который отправляет команды для всех графиков сразу
3. Используйте массив всех chart IDs для массового управления

---

**Дата создания**: 2025-01-01  
**Версия Node-RED**: 3.0.2  
**Версия Dashboard**: Совместима с node-red-dashboard 2.x и 3.x
